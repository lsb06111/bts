<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8" import="edu.example.bts.domain.user.UserDTO"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->

        <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
          <div class="app-brand demo">
            <a href="/bts/" class="app-brand-link">
              <span class="app-brand-logo demo">
              <svg viewBox="0 0 24 24" width="48" height="48" style="width:32px !important;" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M9.03429 5.96305L6.49114 8.49856C6.02369 8.9646 5.59488 9.3921 5.25624 9.77856C5.03877 10.0267 4.82145 10.2984 4.63737 10.5985L4.61259 10.5738C4.56555 10.5269 4.54201 10.5034 4.51839 10.4805C4.07636 10.0516 3.55641 9.71062 2.98636 9.47575C2.9559 9.4632 2.92498 9.45095 2.86314 9.42645L2.48449 9.27641C1.97153 9.07315 1.83482 8.41279 2.22514 8.02365C3.34535 6.90684 4.69032 5.56594 5.33941 5.29662C5.91185 5.05911 6.53023 4.98008 7.12664 5.06822C7.67311 5.14898 8.19006 5.42968 9.03429 5.96305Z" fill="#696cff"></path> <path d="M13.3767 19.3132C13.5816 19.5212 13.7177 19.6681 13.8408 19.8251C14.0031 20.0322 14.1483 20.2523 14.2748 20.4829C14.4172 20.7426 14.5278 21.02 14.749 21.5748C14.929 22.0265 15.5272 22.1459 15.8746 21.7995L15.9586 21.7157C17.0788 20.5988 18.4237 19.2579 18.6938 18.6108C18.9321 18.04 19.0113 17.4235 18.9229 16.8289C18.8419 16.2841 18.5605 15.7688 18.0256 14.9273L15.474 17.4713C14.9959 17.9479 14.5576 18.385 14.1612 18.7273C13.9236 18.9325 13.6637 19.1376 13.3767 19.3132Z" fill="#696cff"></path> <path fill-rule="evenodd" clip-rule="evenodd" d="M14.4467 16.3769L20.2935 10.5476C21.1356 9.70811 21.5566 9.28836 21.7783 8.75458C22.0001 8.22081 22.0001 7.62719 22.0001 6.43996V5.87277C22.0001 4.04713 22.0001 3.13431 21.4312 2.56715C20.8624 2 19.9468 2 18.1157 2H17.5468C16.356 2 15.7606 2 15.2252 2.2211C14.6898 2.4422 14.2688 2.86195 13.4268 3.70146L7.57991 9.53078C6.59599 10.5117 5.98591 11.12 5.74966 11.7075C5.67502 11.8931 5.6377 12.0767 5.6377 12.2692C5.6377 13.0713 6.2851 13.7168 7.57991 15.0077L7.75393 15.1812L9.79245 13.1123C10.0832 12.8172 10.558 12.8137 10.8531 13.1044C11.1481 13.3951 11.1516 13.87 10.8609 14.1651L8.8162 16.2403L8.95326 16.3769C10.2481 17.6679 10.8955 18.3133 11.7 18.3133C11.8777 18.3133 12.0478 18.2818 12.2189 18.2188C12.8222 17.9966 13.438 17.3826 14.4467 16.3769ZM17.1935 9.5312C16.435 10.2874 15.2053 10.2874 14.4468 9.5312C13.6883 8.775 13.6883 7.54895 14.4468 6.79274C15.2053 6.03653 16.435 6.03653 17.1935 6.79274C17.952 7.54895 17.952 8.775 17.1935 9.5312Z" fill="#696cff"></path> </g></svg>  
              </span>
              <span class="app-brand-text demo menu-text fw-bolder ms-2 bts-expand">
				  <span class="bts-letter">B<span class="rest">aepo</span></span>
				  <span class="bts-letter">T<span class="rest">ransition</span></span>
				  <span class="bts-letter">S<span class="rest">ystem</span></span>
				</span>
            </a>

            <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
              <i class="bx bx-chevron-left bx-sm align-middle"></i>
            </a>
          </div>

          <div class="menu-inner-shadow"></div>
			
          <ul class="menu-inner py-1">
            <!-- Dashboard -->
            <li class="menu-item">
              <a href="/bts/" class="menu-link">
                <i class="menu-icon tf-icons bx bx-home-circle"></i>
                <div data-i18n="Analytics">Home</div>
              </a>
            </li>

            <%if(((UserDTO)request.getAttribute("loginUser")).getDept().getDeptno() != 3){ %>
           
           <c:if test="${loginUser.dept.deptno == 1 && loginUser.job.jobno == 2 }">
            <!-- Cards -->
            <li class="menu-item">
              <a href="/bts/deployForm" class="menu-link">
                <i class="menu-icon tf-icons bx bx-send"></i>
                <div data-i18n="Basic">ë°°í¬ ì‹ ì²­</div>
              </a>
            </li>
            </c:if>
            <li class="menu-item">
              <a href="/bts/history?project=&status=&page=1" class="menu-link">
                <i class="menu-icon tf-icons bx bx-history"></i>
                <div data-i18n="Boxicons">ë°°í¬ ì‹ ì²­ ë‚´ì—­</div>
              </a>
            </li>  
            <%} %>
            <c:if test="${loginUser.dept.deptno == 2 }">
	            <li class="menu-item">
	              <a href="/bts/build?page=1" class="menu-link">
	                <i class="menu-icon tf-icons bx bx-play"></i>
	                <div data-i18n="Boxicons">ì§€ê¸ˆ ë¹Œë“œ</div>
	              </a>
	            </li>  
            </c:if> 
            <li class="menu-item">
              <a href="/bts/project/list" class="menu-link">
                <i class="menu-icon tf-icons bx bx-folder"></i>
                <div data-i18n="Boxicons">í”„ë¡œì íŠ¸ ê´€ë¦¬</div>
              </a>
            </li>

            <li class="menu-item">
              <a href="/bts/emp/list2" class="menu-link">
                <i class="menu-icon tf-icons bx bx-group"></i>
                <div data-i18n="Boxicons">ì‚¬ì› ê´€ë¦¬</div>
              </a>
            </li>            
            
            <!-- Extended components -->
            <li class="menu-item">
              <a href="javascript:void(0)" class="menu-link menu-toggle">
                <i class="menu-icon tf-icons bx bx-message-dots"></i>
                <div data-i18n="Extended UI">ê²Œì‹œíŒ</div>
              </a>
              <ul class="menu-sub">
                <li class="menu-item notice-menu">
                  <a href="/bts/notice?page=1" class="menu-link">
                    <div data-i18n="Perfect Scrollbar">ê³µì§€ì‚¬í•­</div>
                  </a>
                </li>
                <li class="menu-item qna-menu">
                  <a href="/bts/qna?page=1" class="menu-link">
                    <div data-i18n="Text Divider">ì§ˆë¬¸ê²Œì‹œíŒ</div>
                  </a>
                </li>
              </ul>
            </li>

          </ul>
          
        
        </aside>
        <!-- / Menu -->
        
		
		
        <!-- Layout container -->
        <div class="layout-page">
        <nav
            class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
            id="layout-navbar"
          >
            <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
              <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
                <i class="bx bx-menu bx-sm"></i>
              </a>
            </div>

            <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
              <!-- Search -->
              <div class="nav-item d-flex align-items-center ms-3 px-3 py-1 rounded-pill shadow-sm"
     style="background-color:#f8f9fa; border:1px solid #e3e6ed;">
  <i class="bx bx-smile text-primary" style="font-size:1.4rem;"></i>
  <span class="fw-semibold ms-2" style="font-size:0.95rem; color:#333;">
     ${loginUser.ename}ë‹˜, ë°˜ê°€ì›Œìš” ğŸ‘‹
  </span>
</div>
              <div class="navbar-nav align-items-center">
                <div class="nav-item d-flex align-items-center">
                  <!-- <i class="bx bx-search fs-4 lh-0"></i>
                   <input
                    type="text"
                    class="form-control border-0 shadow-none"
                    placeholder="Search..."
                    aria-label="Search..."
                  /> -->
                </div>
              </div>
              <!-- /Search -->

              <ul class="navbar-nav flex-row align-items-center ms-auto">
                <li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle hide-arrow" href="#" id="notifDropdown"
     role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <div style="position:relative; display:inline-block; cursor:pointer;">
      <i class="bx bx-bell me-2" style="font-size:1.6rem; color:#333;"></i>
      <!-- ë±ƒì§€: ìˆ«ìëŠ” JSë¡œ ê°±ì‹  ì˜ˆì • -->
      <span id="notifBadge" class="badge rounded-pill bg-danger"
            style="
              position:absolute; top:2px; right:8px; transform: translate(40%,-40%);
              font-size:0.7rem; width:20px; height:20px; display:flex; align-items:center; justify-content:center;
            ">
        
      </span>
    </div>
  </a>

	  <!-- ë“œë¡­ë‹¤ìš´: ë¦¬ìŠ¤íŠ¸ ì˜ì—­ë§Œ ë¹„ì›Œë‘  -->
	  <ul class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="notifDropdown"
	      style="width: 360px; max-height: 420px; overflow: hidden; border-radius: 12px;">
	    <!-- í—¤ë” -->
	    <li class="px-3 py-2 d-flex justify-content-between align-items-center"
	        style="border-bottom: 1px solid #f1f1f1;">
	      <span class="fw-semibold" style="color:#333;">ì•Œë¦¼</span>
	      <div class="d-flex gap-2">
	        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMarkAllRead" onclick="readAllNotis(${loginUser.id})">ëª¨ë‘ ì½ìŒ</button>
	      </div>
	    </li>
	
	    <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
	    <li>
	      <div id="notifList"
	           style="max-height: 340px; overflow-y: auto; padding: 8px 0;">
	        
	      </div>
	    </li>
	
	    
	  </ul>
	</li>
                

                <!-- User -->
                <li class="nav-item navbar-dropdown dropdown-user dropdown">
                  <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                    <div style="cursor: pointer;">
                    	<i class="bx bx-cog me-2" style="font-size:1.6rem;color:#333;"></i>  
                    </div>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" href="#">
                        <div class="d-flex">
                          <div class="flex-shrink-0 me-3">
                            <div>
                              <img src="/bts/resources/assets/img/oti_logo.png" alt class="w-px-40 h-auto rounded-circle" />
                            </div>
                          </div>
                          <div class="flex-grow-1">
                            <span class="fw-semibold d-block">${loginUser.ename }</span>
                            <small class="text-muted">${loginUser.dept.dname}</small>
                          </div>
                        </div>
                      </a>
                    </li>
                    <li>
                      <div class="dropdown-divider"></div>
                    </li>
                    <li>
					  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editInfoModal">
					    <i class="bx bx-user me-2"></i>
					    <span class="align-middle">ì •ë³´ ìˆ˜ì •</span>
					  </a>
					</li>
                    
                    <li>
                      <a class="dropdown-item" href="${pageContext.request.contextPath}/auth/logout">
                        <i class="bx bx-power-off me-2"></i>
                        <span class="align-middle">ë¡œê·¸ì•„ì›ƒ</span>
                      </a>
                    </li>
                  </ul>
                </li>
                <!--/ User -->
              </ul>
            </div>
          </nav>

<div class="modal fade" id="editInfoModal" tabindex="-1" aria-labelledby="editInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:12px;">

      <!-- í—¤ë” -->
      <div class="modal-header" style="border-bottom:none;">
        <h5 class="modal-title fw-bold" id="editInfoModalLabel" style="color:#4a5eff;">
          <i class="bi bi-person-circle me-2"></i>ì •ë³´ ìˆ˜ì •
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- ë°”ë”” -->
      <div class="modal-body" style="padding:10px 40px;">
        <c:if test="${loginUser.dept.deptno == 1 }">
          <div class="mb-1">
            <label class="form-label fw-semibold">GitHub ID</label>
            <input id="github_username" type="text" class="form-control" value="${loginUser.githubUsername}" style="border-radius:8px;" placeholder="GitHub IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
          </div>
          </c:if>
          <div class="mb-1">
            <label class="form-label fw-semibold">ì „í™”ë²ˆí˜¸</label>
            <input id="phone_number" type="tel" pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" class="form-control" value="${loginUser.phone}" style="border-radius:8px;" placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
          </div>
          <div class="row mb-3">
			  <div class="col-md-6">
			    <label class="form-label fw-semibold">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
			    <input id="password" type="password" class="form-control" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="border-radius:8px;">
			  </div>
			  <div class="col-md-6">
			    <label class="form-label fw-semibold">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
			    <input id="password_check" type="password" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="border-radius:8px;">
			  </div>
			</div>
        
      </div>

      <!-- í‘¸í„° -->
      <div class="modal-footer" style="border-top:none;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                style="border-radius:8px;">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" onclick="updateInfo(${loginUser.id})"
                style="background-color:#4a5eff; border:none; border-radius:8px;">
          ì €ì¥
        </button>
      </div>

    </div>
  </div>
</div>
<!-- chat -->
		
		<%@ include file="/WEB-INF/views/jspf/chat/chat.jspf" %>
		<!-- / chat -->
<script>

(function () {
	  // ì„œë²„ì—ì„œ ë‚´ë ¤ì£¼ëŠ” ë¡œê·¸ì¸ ìœ ì € id
	  var userId = '${loginUser.id}';
	  if (!userId) return;

	  // ì´ë¯¸ ì—´ë¦° SSEê°€ ìˆìœ¼ë©´ ì¬ìƒì„± ê¸ˆì§€(ì¤‘ë³µ ì—°ê²° ë°©ì§€)
	  if (window.__btsSSE && window.__btsSSE.readyState === 1 /* OPEN */) return;

	  // ì´ì „ ì¸ìŠ¤í„´ìŠ¤ê°€ ë‚¨ì•„ìˆë‹¤ë©´ ì•ˆì „í•˜ê²Œ ë‹«ê¸°
	  if (window.__btsSSE) {
	    try { window.__btsSSE.close(); } catch (e) {}
	  }

	  var es = new EventSource('/bts/sse/subscribe?userId=' + encodeURIComponent(userId));
	  window.__btsSSE = es; // ì „ì—­ì— ì €ì¥í•´ì„œ ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì¬ì¤‘ë³µ ìƒì„± ë°©ì§€

	  es.addEventListener('INIT', function (e) {
	    // ì—°ê²° ì„±ê³µ ë¡œê·¸ í•„ìš” ì—†ìœ¼ë©´ ë¹„ì›Œë‘¬ë„ ë¨
	    // console.log('SSE connected:', e.data);
	  });

	  es.addEventListener('REQUEST_CREATED', function (e) {
	    try {
	      var data = JSON.parse(e.data);
	      var badge = document.getElementById('notifBadge');
	      var list  = document.getElementById('notifList');
	      if (!badge || !list) return;

	      var count = parseInt(badge.textContent || '0', 10) || 0;
	      if (count === 0) list.innerHTML = '';
	      badge.textContent = count + 1;

	      var htmlDom =
	        '<a class="dropdown-item py-2 px-3 d-flex align-items-start" ' +
	          'href="' + data.notification.slug + '" ' +
	          'onclick="handleNotiClick(' + data.notification.id + ',\'' + data.notification.slug + '\')">' +
	          '<div class="flex-grow-1">' +
	            '<div class="fw-semibold text-truncate">[' + data.notification.title + '] ' +
	              (data.notification.message === 'ë°˜ë ¤' ? 'ê²°ì¬ê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê²°ì¬ ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.') +
	            '</div>' +
	            '<small class="text-muted">ë°©ê¸ˆ ì „</small>' +
	          '</div>' +
	        '</a>';

	      //list.insertAdjacentHTML('beforeend', html);
			list.innerHTML += htmlDom;
	      var bellIcon = document.querySelector('.bx-bell');
	      if (bellIcon && !bellIcon.classList.contains('bell-blink')) {
	        bellIcon.classList.add('bell-blink');
	      }
	    } catch (err) {}
	  });

	  es.onerror = function () {
	    // EventSourceëŠ” ìë™ ì¬ì—°ê²°ë¨. ì½˜ì†” ìŠ¤íŒ¸ ë°©ì§€ìš©ìœ¼ë¡œ ë¹„ì›Œë‘ 
	  };

	  // ì „ì²´ í˜ì´ì§€ ì´íƒˆ/ìƒˆë¡œê³ ì¹¨ ì‹œ ì»¤ë„¥ì…˜ ëª…ì‹œ ì¢…ë£Œ
	  window.addEventListener('beforeunload', function () {
	    try { es.close(); } catch (e) {}
	  });
	})();

document.addEventListener('DOMContentLoaded', function() {
	const userId = '${loginUser.id}';
	$.get('/bts/getNotifications?userId='+userId,
			function(data, status){
				if(status == 'success'){
					document.querySelector('#notifBadge').textContent = data.length;
					const notiListDom = document.querySelector('#notifList');
					for(let noti of data){
						const notiDom = `<a class="dropdown-item py-2 px-3 d-flex align-items-start" href="\${noti.slug}" onclick="handleNotiClick(\${noti.id},'\${noti.slug}')">
					          
				          <div class="flex-grow-1">
				            <div class="fw-semibold text-truncate">[\${noti.title}] \${noti.message == 'ë°˜ë ¤' ? 'ê²°ì¬ê°€ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê²°ì¬ ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.'}</div>
				            <small class="text-muted">[\${noti.createdAt.substring(0, noti.createdAt.length - 4)}]</small>
				          </div>
				        </a>`;
						notiListDom.innerHTML = notiListDom.innerHTML+ notiDom;
					}
					// if no length
					if(data.length == 0){
						const nothingDom = `<div class="text-center py-4 text-muted">
							  <i class="bx bx-bell" style="font-size:2rem;"></i>
							  <div class="mt-1 small">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
							</div>`;
						notiListDom.innerHTML = nothingDom;
					}
				}
			});
	
	
	
  const currentPath = window.location.pathname; // ì¿¼ë¦¬ ì œì™¸í•œ ê²½ë¡œë§Œ ë¹„êµ
	console.log(currentPath);
  document.querySelectorAll('.menu-link').forEach(link => {
    const linkPath = new URL(link.href).pathname;

    if (currentPath === linkPath) {
      const item = link.closest('.menu-item');
      console.log(item.classList);
      if (item) {
        item.classList.add('active');

        const parentMenu = item.closest('.menu-sub')?.closest('.menu-item');
        if (parentMenu) {
          parentMenu.classList.add('open');
        }
      }
    }
    else if(currentPath.includes('/bts/notice/')){
    	document.querySelector('.notice-menu').parentNode.parentElement.classList.add('open');
    	document.querySelector('.notice-menu').classList.add('active');
    }else if(currentPath.includes('/bts/qna/')){
    	document.querySelector('.qna-menu').parentNode.parentElement.classList.add('open');
    	document.querySelector('.qna-menu').classList.add('active');
    }
    
  });
  
  
  
});

function handleNotiClick(notiId, slug){
	$.get('/bts/readNotification?id='+notiId,
			function(data, status){
				if(status == 'success'){
					location.href = slug;
				}
			});
}

function readAllNotis(userId){
	$.get('/bts/readAllNotifications?userId='+userId,
			function(data, status){
				if(status == 'success'){
					document.querySelector('#notifBadge').textContent = 0;
					const notiListDom = document.querySelector('#notifList');
					notiListDom.innerHTML = `<div class="text-center py-4 text-muted">
						  <i class="bx bx-bell" style="font-size:2rem;"></i>
						  <div class="mt-1 small">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
						</div>`;
						
					const bellIcon = document.querySelector('.bx-bell');
					  if (bellIcon && bellIcon.classList.contains('bell-blink')) {
					    bellIcon.classList.remove('bell-blink');
					}
				}
			});
}


</script>    